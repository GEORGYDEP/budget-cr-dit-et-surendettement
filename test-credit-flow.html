<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test du flux de cr√©dit - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 20px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 15px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
        }
        .warning {
            background: #fef3c7;
            color: #92400e;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #f8fafc;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #e2e8f0;
        }
        .log-entry.info { color: #2563eb; }
        .log-entry.success { color: #059669; }
        .log-entry.error { color: #dc2626; }
        .log-entry.warning { color: #d97706; }
    </style>
</head>
<body>
    <h1>üß™ Test du flux de cr√©dit - Debug complet</h1>

    <div class="test-section">
        <div class="test-title">üìã Contexte du bug</div>
        <div class="test-result info">
            <strong>Probl√®me signal√© :</strong> Apr√®s avoir choisi "Faire un cr√©dit", le jeu reste bloqu√© et ne passe pas au mois 2.
        </div>
        <div class="test-result info">
            <strong>Correction attendue :</strong> Le callback de la modal doit mettre √† jour currentMonth=2 et appeler nextMonth() pour afficher l'√©v√©nement du mois 2.
        </div>
    </div>

    <div class="test-section">
        <div class="test-title">üîç Test 1 : V√©rification du callback de la modal</div>
        <button onclick="testModalCallback()">Lancer Test 1</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üîç Test 2 : Simulation du flux complet handleTakeCredit()</div>
        <button onclick="testHandleTakeCredit()">Lancer Test 2</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üîç Test 3 : V√©rification de l'√©v√©nement du mois 2</div>
        <button onclick="testMonth2Event()">Lancer Test 3</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üîç Test 4 : Test d'int√©gration complet</div>
        <button onclick="testFullIntegration()">Lancer Test 4</button>
        <div id="test4-result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">üìä Console de logs</div>
        <button onclick="clearLogs()">Effacer les logs</button>
        <div id="logs-container" class="log-container"></div>
    </div>

    <script src="js/data.js"></script>

    <script>
        // Mock du jeu pour les tests
        let logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ timestamp, message, type });
            updateLogsDisplay();
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateLogsDisplay() {
            const container = document.getElementById('logs-container');
            container.innerHTML = logs.map(log =>
                `<div class="log-entry ${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }

        function showResult(elementId, html) {
            document.getElementById(elementId).innerHTML = html;
        }

        // Test 1 : V√©rification du callback de la modal
        function testModalCallback() {
            addLog('=== D√âBUT TEST 1 : Callback de la modal ===', 'info');
            let result = '';
            let success = true;

            // Simuler un objet jeu simple
            const mockGame = {
                state: { currentMonth: 1 },
                modalCallback: null,
                nextMonthCalled: false,
                updateDisplayCalled: false,

                showModal(title, content, callback) {
                    addLog(`showModal appel√© avec titre: "${title}"`, 'info');
                    this.modalCallback = callback;
                    addLog('Callback stock√© dans modalCallback', 'success');
                },

                hideModal() {
                    addLog('hideModal appel√©', 'info');
                    this.modalCallback = null;
                },

                onModalConfirm() {
                    addLog('onModalConfirm appel√©', 'info');
                    const callback = this.modalCallback;
                    this.hideModal();
                    if (callback) {
                        addLog('Callback trouv√©, ex√©cution...', 'success');
                        callback();
                        addLog('Callback ex√©cut√©', 'success');
                    } else {
                        addLog('ERREUR: Aucun callback d√©fini!', 'error');
                        success = false;
                    }
                },

                updateDisplay() {
                    this.updateDisplayCalled = true;
                    addLog('updateDisplay appel√©', 'success');
                },

                nextMonth() {
                    this.nextMonthCalled = true;
                    addLog(`nextMonth appel√© pour mois ${this.state.currentMonth}`, 'success');
                }
            };

            // Simuler handleTakeCredit
            addLog('Simulation de handleTakeCredit...', 'info');
            mockGame.showModal('Test cr√©dit', 'Message de test', () => {
                addLog('Callback ex√©cut√©: mise √† jour currentMonth √† 2', 'info');
                mockGame.state.currentMonth = 2;
                mockGame.updateDisplay();
                mockGame.nextMonth();
            });

            // Simuler le clic sur "Compris"
            addLog('Simulation du clic sur le bouton "Compris"...', 'warning');
            mockGame.onModalConfirm();

            // V√©rifications
            if (mockGame.state.currentMonth === 2) {
                result += '<div class="test-result success">‚úÖ currentMonth mis √† jour √† 2</div>';
                addLog('‚úÖ currentMonth = 2', 'success');
            } else {
                result += '<div class="test-result error">‚ùå currentMonth n\'a pas √©t√© mis √† jour (valeur: ' + mockGame.state.currentMonth + ')</div>';
                addLog('‚ùå currentMonth non mis √† jour', 'error');
                success = false;
            }

            if (mockGame.updateDisplayCalled) {
                result += '<div class="test-result success">‚úÖ updateDisplay() a √©t√© appel√©</div>';
                addLog('‚úÖ updateDisplay appel√©', 'success');
            } else {
                result += '<div class="test-result error">‚ùå updateDisplay() n\'a PAS √©t√© appel√©</div>';
                addLog('‚ùå updateDisplay non appel√©', 'error');
                success = false;
            }

            if (mockGame.nextMonthCalled) {
                result += '<div class="test-result success">‚úÖ nextMonth() a √©t√© appel√©</div>';
                addLog('‚úÖ nextMonth appel√©', 'success');
            } else {
                result += '<div class="test-result error">‚ùå nextMonth() n\'a PAS √©t√© appel√©</div>';
                addLog('‚ùå nextMonth non appel√©', 'error');
                success = false;
            }

            if (mockGame.modalCallback !== null) {
                result += '<div class="test-result error">‚ùå Le callback n\'a pas √©t√© effac√© apr√®s hideModal()</div>';
                addLog('‚ùå Callback non effac√©', 'error');
                success = false;
            } else {
                result += '<div class="test-result success">‚úÖ Le callback a √©t√© correctement effac√©</div>';
                addLog('‚úÖ Callback effac√©', 'success');
            }

            if (success) {
                result = '<div class="test-result success"><strong>‚úÖ TEST 1 R√âUSSI</strong> - Le callback de la modal fonctionne correctement</div>' + result;
                addLog('=== TEST 1 R√âUSSI ===', 'success');
            } else {
                result = '<div class="test-result error"><strong>‚ùå TEST 1 √âCHOU√â</strong> - Des probl√®mes ont √©t√© d√©tect√©s</div>' + result;
                addLog('=== TEST 1 √âCHOU√â ===', 'error');
            }

            showResult('test1-result', result);
        }

        // Test 2 : Simulation du flux complet handleTakeCredit()
        function testHandleTakeCredit() {
            addLog('=== D√âBUT TEST 2 : Flux complet handleTakeCredit ===', 'info');
            let result = '';
            let success = true;

            const mockState = {
                currentMonth: 1,
                monthlyIncome: 2000,
                monthlyFixedExpenses: 1200,
                monthlyVariableExpenses: 900,
                monthlyDebt: 0,
                credits: 0,
                totalScore: 100,
                badChoices: 0,
                balance: 500
            };

            const currentDeficit = 100; // D√©ficit de 100‚Ç¨

            addLog(`√âtat initial: revenus=${mockState.monthlyIncome}, fixes=${mockState.monthlyFixedExpenses}, variables=${mockState.monthlyVariableExpenses}`, 'info');
            addLog(`D√©ficit √† combler: ${currentDeficit}‚Ç¨`, 'warning');

            // Simulation de la logique handleTakeCredit
            const creditCost = Math.round(currentDeficit * 1.15);
            const interestAmount = Math.round(currentDeficit * 0.15);
            const monthlyRepayment = Math.round(creditCost / 12);

            addLog(`Cr√©dit calcul√©: ${creditCost}‚Ç¨ (int√©r√™ts: ${interestAmount}‚Ç¨)`, 'info');
            addLog(`Remboursement mensuel: ${monthlyRepayment}‚Ç¨`, 'info');

            // Appliquer le cr√©dit
            mockState.monthlyIncome += currentDeficit;
            mockState.monthlyDebt += monthlyRepayment;
            mockState.credits += 1;
            mockState.totalScore -= creditCost;
            mockState.badChoices += 1;

            const newResteDisponible = mockState.monthlyIncome - mockState.monthlyFixedExpenses - mockState.monthlyVariableExpenses;

            addLog(`Nouveaux revenus: ${mockState.monthlyIncome}‚Ç¨`, 'success');
            addLog(`Nouvelle dette mensuelle: ${mockState.monthlyDebt}‚Ç¨`, 'warning');
            addLog(`Nouveau reste disponible: ${newResteDisponible}‚Ç¨`, 'info');

            // V√©rifications
            if (mockState.monthlyIncome === 2100) {
                result += '<div class="test-result success">‚úÖ Revenus augment√©s correctement (2000 + 100 = 2100)</div>';
                addLog('‚úÖ Revenus corrects', 'success');
            } else {
                result += `<div class="test-result error">‚ùå Revenus incorrects: ${mockState.monthlyIncome} au lieu de 2100</div>`;
                addLog('‚ùå Revenus incorrects', 'error');
                success = false;
            }

            if (mockState.monthlyDebt === 10) {
                result += '<div class="test-result success">‚úÖ Dette mensuelle correcte (115 / 12 ‚âà 10)</div>';
                addLog('‚úÖ Dette mensuelle correcte', 'success');
            } else {
                result += `<div class="test-result error">‚ùå Dette mensuelle incorrecte: ${mockState.monthlyDebt} au lieu de 10</div>`;
                addLog('‚ùå Dette mensuelle incorrecte', 'error');
                success = false;
            }

            if (newResteDisponible === 0) {
                result += '<div class="test-result success">‚úÖ Budget √©quilibr√© (reste = 0‚Ç¨)</div>';
                addLog('‚úÖ Budget √©quilibr√©', 'success');
            } else {
                result += `<div class="test-result error">‚ùå Budget non √©quilibr√©: reste = ${newResteDisponible}‚Ç¨</div>`;
                addLog('‚ùå Budget non √©quilibr√©', 'error');
                success = false;
            }

            if (mockState.totalScore === -15) {
                result += '<div class="test-result success">‚úÖ Score p√©nalis√© correctement (100 - 115 = -15)</div>';
                addLog('‚úÖ Score correct', 'success');
            } else {
                result += `<div class="test-result error">‚ùå Score incorrect: ${mockState.totalScore} au lieu de -15</div>`;
                addLog('‚ùå Score incorrect', 'error');
                success = false;
            }

            if (mockState.credits === 1) {
                result += '<div class="test-result success">‚úÖ Compteur de cr√©dits incr√©ment√©</div>';
                addLog('‚úÖ Compteur de cr√©dits OK', 'success');
            } else {
                result += `<div class="test-result error">‚ùå Compteur de cr√©dits incorrect: ${mockState.credits}</div>`;
                addLog('‚ùå Compteur de cr√©dits incorrect', 'error');
                success = false;
            }

            if (success) {
                result = '<div class="test-result success"><strong>‚úÖ TEST 2 R√âUSSI</strong> - La logique de cr√©dit fonctionne correctement</div>' + result;
                addLog('=== TEST 2 R√âUSSI ===', 'success');
            } else {
                result = '<div class="test-result error"><strong>‚ùå TEST 2 √âCHOU√â</strong> - Des probl√®mes ont √©t√© d√©tect√©s</div>' + result;
                addLog('=== TEST 2 √âCHOU√â ===', 'error');
            }

            showResult('test2-result', result);
        }

        // Test 3 : V√©rification de l'√©v√©nement du mois 2
        function testMonth2Event() {
            addLog('=== D√âBUT TEST 3 : √âv√©nement du mois 2 ===', 'info');
            let result = '';
            let success = true;

            addLog('Recherche de l\'√©v√©nement pour le mois 2...', 'info');
            const event = GAME_DATA.monthlyEvents.find(e => e.month === 2);

            if (event) {
                result += '<div class="test-result success">‚úÖ √âv√©nement trouv√© pour le mois 2</div>';
                result += '<div class="test-result info"><strong>Titre:</strong> ' + event.title + '</div>';
                result += '<div class="test-result info"><strong>Ic√¥ne:</strong> ' + event.icon + '</div>';
                result += '<div class="test-result info"><strong>Description:</strong> ' + event.description + '</div>';
                result += '<div class="test-result info"><strong>Nombre de choix:</strong> ' + event.choices.length + '</div>';

                addLog(`‚úÖ √âv√©nement trouv√©: "${event.title}"`, 'success');
                addLog(`Nombre de choix: ${event.choices.length}`, 'info');

                // V√©rifier que les choix sont valides
                event.choices.forEach((choice, index) => {
                    addLog(`Choix ${index + 1}: ${choice.text}`, 'info');
                    if (!choice.text || !choice.icon || !choice.consequence) {
                        result += `<div class="test-result error">‚ùå Choix ${index + 1} invalide</div>`;
                        addLog(`‚ùå Choix ${index + 1} invalide`, 'error');
                        success = false;
                    }
                });

                if (success) {
                    result += '<div class="test-result success">‚úÖ Tous les choix sont valides</div>';
                    addLog('‚úÖ Tous les choix valides', 'success');
                }
            } else {
                result += '<div class="test-result error">‚ùå ERREUR CRITIQUE: Aucun √©v√©nement trouv√© pour le mois 2!</div>';
                result += '<div class="test-result warning">Le jeu ne pourra pas progresser apr√®s le cr√©dit si aucun √©v√©nement n\'existe pour le mois 2.</div>';
                addLog('‚ùå Aucun √©v√©nement pour le mois 2!', 'error');
                success = false;
            }

            if (success) {
                result = '<div class="test-result success"><strong>‚úÖ TEST 3 R√âUSSI</strong> - L\'√©v√©nement du mois 2 existe et est valide</div>' + result;
                addLog('=== TEST 3 R√âUSSI ===', 'success');
            } else {
                result = '<div class="test-result error"><strong>‚ùå TEST 3 √âCHOU√â</strong> - Probl√®me avec l\'√©v√©nement du mois 2</div>' + result;
                addLog('=== TEST 3 √âCHOU√â ===', 'error');
            }

            showResult('test3-result', result);
        }

        // Test 4 : Test d'int√©gration complet
        function testFullIntegration() {
            addLog('=== D√âBUT TEST 4 : Test d\'int√©gration complet ===', 'info');
            let result = '';
            let allTestsPassed = true;

            // Tester tout le flux dans l'ordre
            addLog('√âtape 1/5: Test du callback...', 'info');
            testModalCallback();

            setTimeout(() => {
                addLog('√âtape 2/5: Test de la logique de cr√©dit...', 'info');
                testHandleTakeCredit();

                setTimeout(() => {
                    addLog('√âtape 3/5: Test de l\'√©v√©nement du mois 2...', 'info');
                    testMonth2Event();

                    setTimeout(() => {
                        addLog('√âtape 4/5: Synth√®se des r√©sultats...', 'info');

                        result += '<div class="test-result info">üìã <strong>Synth√®se des tests</strong></div>';
                        result += '<div class="test-result info">Tous les tests individuels ont √©t√© ex√©cut√©s. Consultez les logs ci-dessous pour les d√©tails.</div>';

                        addLog('√âtape 5/5: G√©n√©ration du rapport...', 'info');

                        result += '<div class="test-result success">‚úÖ <strong>Conclusion:</strong> Si tous les tests ci-dessus sont verts, le flux de cr√©dit devrait fonctionner correctement.</div>';
                        result += '<div class="test-result warning">‚ö†Ô∏è <strong>Note:</strong> Si le probl√®me persiste en jeu r√©el, v√©rifiez:</div>';
                        result += '<div class="test-result warning">1. Que le bouton "Compris" appelle bien game.onModalConfirm()</div>';
                        result += '<div class="test-result warning">2. Que la modal ne bloque pas les √©v√©nements</div>';
                        result += '<div class="test-result warning">3. Que la console du navigateur ne montre pas d\'erreurs JavaScript</div>';

                        addLog('=== TEST 4 TERMIN√â ===', 'success');

                        showResult('test4-result', result);
                    }, 500);
                }, 500);
            }, 500);
        }

        // Message de bienvenue
        addLog('üß™ Page de test charg√©e', 'success');
        addLog('Cliquez sur les boutons pour lancer les tests', 'info');
    </script>
</body>
</html>
